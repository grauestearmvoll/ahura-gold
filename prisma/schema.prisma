// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Ürün Tanımı - Product Definition
model Product {
  id              String   @id @default(cuid())
  productCode     String   @unique
  name            String
  buyMilyem       Float    // Alış milyemi (sabit)
  sellMilyem      Float    // Satış milyemi (sabit)
  goldBuyPrice    Float    // Has altın alış fiyatı (sabit)
  goldSellPrice   Float    // Has altın satış fiyatı (sabit)
  unitType        String   // "ADET" veya "GRAM"
  gramPerPiece    Float?   // Adet başına gramaj (ADET için)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  transactions    ProductTransaction[]
  consignments    Consignment[]
}

// Ürün İşlemleri - Product Transactions (Alış/Satış)
model ProductTransaction {
  id                 String   @id @default(cuid())
  transactionCode    String   @unique
  transactionType    String   // "ALIS" veya "SATIS"
  productId          String
  quantity           Float    // Miktar (gram veya adet)
  milyem             Float    // İşlem anındaki milyem (alış için buyMilyem, satış için sellMilyem)
  goldBuyPrice       Float    // Has altın alış fiyatı (işlem anında)
  goldSellPrice      Float    // Has altın satış fiyatı (işlem anında)
  discountAmount     Float    @default(0) // İskonto miktarı
  totalAmount        Float    // Toplam tutar (TL)
  remainingStock     Float    // İşlem sonrası kalan stok
  notes              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  product            Product  @relation(fields: [productId], references: [id])
  payment            Payment?
}

// Emanet İşlemleri - Consignment Transactions
model Consignment {
  id                 String    @id @default(cuid())
  transactionCode    String    @unique
  customerId         String
  consignmentType    String    // "VERME" veya "ALMA"
  itemType           String    // "URUN", "TL", "DOLAR", "EURO"
  productId          String?
  quantity           Float?    // Miktar (ürün için)
  karat              Float?    // Milyem (ürün için)
  amount             Float?    // Tutar (para için)
  currencyBuyPrice   Float?    // Döviz alış fiyatı
  currencySellPrice  Float?    // Döviz satış fiyatı
  goldBuyPrice       Float?    // Has altın alış fiyatı (ürün için)
  goldSellPrice      Float?    // Has altın satış fiyatı (ürün için)
  deliveryDate       DateTime? // Teslim tarihi
  returnDate         DateTime? // İade tarihi
  notes              String?
  status             String    @default("ACTIVE") // "ACTIVE", "RETURNED"
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  customer           Customer  @relation(fields: [customerId], references: [id])
  product            Product?  @relation(fields: [productId], references: [id])
}
// Müşteri - Customer
model Customer {
  id                 String        @id @default(cuid())
  customerCode       String        @unique
  name               String
  tcNo               String?       // TC Kimlik No
  phone              String
  balance            Float         @default(0) // Bakiye (has altın gramı cinsinden)
  balanceCurrency    String?       // Bakiye para birimi (TL, DOLAR, EURO) - altın ise null
  isFavorite         Boolean       @default(false) // Dashboard'da gösterim için
  notes              String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  consignments       Consignment[]
  payments           Payment[]
}

// Ödemeler - Payments
model Payment {
  id                    String              @id @default(cuid())
  transactionCode       String              
  productTransactionId  String?             @unique
  customerId            String?
  paymentType           String              // "ODEME" veya "TAHSILAT"
  totalAmount           Float               // Toplam tutar
  paidAmount            Float               @default(0) // Ödenen tutar
  remainingAmount       Float               // Kalan tutar
  status                String              @default("PENDING") // "PENDING", "PARTIAL", "COMPLETED"
  paymentMethod         String?             // "NAKIT", "BANKA", "KREDI_KARTI"
  bankName              String?
  accountHolder         String?
  accountHolderTcNo     String?
  eftQueryNo            String?
  notes                 String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  productTransaction    ProductTransaction? @relation(fields: [productTransactionId], references: [id])
  customer              Customer?           @relation(fields: [customerId], references: [id])
  paymentDetails        PaymentDetail[]
}

// Ödeme Detayları - Payment Details (Kısmi ödemeler için)
model PaymentDetail {
  id                String   @id @default(cuid())
  paymentId         String
  amount            Float    // Ödenen miktar
  paymentMethod     String   // "NAKIT", "BANKA", "KREDI_KARTI"
  bankName          String?
  accountHolder     String?
  accountHolderTcNo String?
  eftQueryNo        String?
  notes             String?
  createdAt         DateTime @default(now())

  payment           Payment  @relation(fields: [paymentId], references: [id])
}

// Sayaçlar - Counters for sequential codes
model Counter {
  id                String   @id @default(cuid())
  name              String   @unique // "PRODUCT_CODE", "CUSTOMER_CODE", "TRANSACTION_CODE", etc.
  value             Int      @default(0)
  updatedAt         DateTime @updatedAt
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
